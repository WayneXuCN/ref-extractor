<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RefExtractor Debug Console</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .console-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        .status-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .status-card.status-success {
            border-left-color: #28a745;
        }
        .status-card.status-warning {
            border-left-color: #ffc107;
        }
        .status-card.status-error {
            border-left-color: #dc3545;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            margin: 0;
        }
        .log-entry.log-error {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
        }
        .log-entry.log-warn {
            background-color: #fff8e1;
            border-left: 3px solid #ff9800;
        }
        .log-entry.log-info {
            background-color: #e8f5e8;
            border-left: 3px solid #4caf50;
        }
        .log-entry.log-debug {
            background-color: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }
        .performance-bar {
            height: 20px;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.25rem;
        }
        .test-result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .module-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.375rem;
            margin: 0.125rem;
        }
        .module-loaded {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .module-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="console-header">
        <div class="container">
            <h1 class="display-4 mb-0">
                <i class="fas fa-terminal me-3"></i>RefExtractor Debug Console
            </h1>
            <p class="lead mb-0">System monitoring, debugging, and testing interface</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-chart-line me-2"></i>System Status</h2>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card status-success h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-heartbeat text-success"></i> System Health
                        </h5>
                        <h3 id="system-health" class="text-success">Checking...</h3>
                        <small id="system-uptime" class="text-muted">Uptime: Loading...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card status-success h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-puzzle-piece text-primary"></i> Modules
                        </h5>
                        <h3 id="modules-loaded" class="text-primary">0/0</h3>
                        <small class="text-muted">Loaded successfully</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card status-warning h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-exclamation-triangle text-warning"></i> Errors
                        </h5>
                        <h3 id="error-count" class="text-warning">0</h3>
                        <small class="text-muted">Total errors logged</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card status-error h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-tachometer-alt text-info"></i> Performance
                        </h5>
                        <h3 id="performance-score" class="text-info">100%</h3>
                        <small class="text-muted">System performance</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modules Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-cubes me-2"></i>Module Loading Status
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="module-status-container">
                            <!-- Module badges will be populated here -->
                        </div>
                        <div class="mt-3">
                            <h6>Module Details:</h6>
                            <div id="module-details" class="log-container" style="max-height: 200px;">
                                <!-- Module details will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>System Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody id="system-info-table">
                                <!-- System info will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-memory me-2"></i>Memory & Performance
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="memory-info">
                            <!-- Memory info will be populated here -->
                        </div>
                        <div class="mt-3">
                            <h6>Performance Metrics:</h6>
                            <div id="performance-metrics">
                                <!-- Performance metrics will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Logs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-bug me-2"></i>Error & Debug Logs
                        </h3>
                        <div>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="logLevel" id="log-all" value="all" checked>
                                <label class="btn btn-outline-secondary" for="log-all">All</label>
                                
                                <input type="radio" class="btn-check" name="logLevel" id="log-error" value="error">
                                <label class="btn btn-outline-danger" for="log-error">Errors</label>
                                
                                <input type="radio" class="btn-check" name="logLevel" id="log-warn" value="warn">
                                <label class="btn btn-outline-warning" for="log-warn">Warnings</label>
                                
                                <input type="radio" class="btn-check" name="logLevel" id="log-info" value="info">
                                <label class="btn btn-outline-success" for="log-info">Info</label>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container">
                            <!-- Log entries will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing Interface -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-vial me-2"></i>Function Testing
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-primary btn-sm me-2" onclick="runBasicTests()">
                                <i class="fas fa-play"></i> Run Basic Tests
                            </button>
                            <button class="btn btn-secondary btn-sm me-2" onclick="runPerformanceTests()">
                                <i class="fas fa-stopwatch"></i> Performance Tests
                            </button>
                            <button class="btn btn-success btn-sm" onclick="runIntegrationTests()">
                                <i class="fas fa-link"></i> Integration Tests
                            </button>
                        </div>
                        <div id="test-results" class="mt-3">
                            <!-- Test results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-file-upload me-2"></i>File Testing
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="test-file" class="form-label">Select test document:</label>
                            <input type="file" class="form-control form-control-sm" id="test-file" accept=".docx,.odt">
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="testFileProcessing()">
                            <i class="fas fa-cogs"></i> Test File Processing
                        </button>
                        <div id="file-test-results" class="mt-3">
                            <!-- File test results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Tools -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-download me-2"></i>Export & Analysis Tools
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" onclick="exportLogs()">
                                <i class="fas fa-file-export"></i> Export Logs
                            </button>
                            <button class="btn btn-outline-success" onclick="exportSystemInfo()">
                                <i class="fas fa-chart-bar"></i> Export System Info
                            </button>
                            <button class="btn btn-outline-warning" onclick="exportErrorReport()">
                                <i class="fas fa-bug"></i> Export Error Report
                            </button>
                            <button class="btn btn-outline-info" onclick="generateDiagnostics()">
                                <i class="fas fa-stethoscope"></i> Generate Diagnostics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn btn-primary refresh-btn" onclick="refreshConsole()" title="Refresh Console">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    
    <!-- Core modules (in order) -->
    <script src="js/config.js"></script>
    <script src="js/logger.js"></script>
    <script src="js/errorHandler.js"></script>
    <script src="js/documentParser.js"></script>
    <script src="js/fieldExtractor.js"></script>
    <script src="js/citationProcessor.js"></script>
    <script src="js/zoteroIntegration.js"></script>
    <script src="js/outputFormatter.js"></script>
    <script src="js/uiController.js"></script>

    <!-- Debug Console Script -->
    <script>
        /**
         * Debug Console Implementation
         */
        class DebugConsole {
            constructor() {
                this.startTime = Date.now();
                this.modules = [
                    'RefExtractorConfig',
                    'RefExtractorLogger', 
                    'RefExtractorErrorHandler',
                    'RefExtractorDocumentParser',
                    'RefExtractorFieldExtractor',
                    'RefExtractorCitationProcessor',
                    'RefExtractorZoteroIntegration',
                    'RefExtractorOutputFormatter',
                    'RefExtractorUIController'
                ];
                this.logEntries = [];
                this.currentLogLevel = 'all';
                
                this.init();
            }

            init() {
                console.log('Debug Console initializing...');
                
                // Set up log intercepting
                this.setupLogInterception();
                
                // Initial system check
                this.refreshSystemStatus();
                this.checkModuleStatus();
                this.updateSystemInfo();
                this.setupEventListeners();
                
                // Auto-refresh every 30 seconds
                setInterval(() => this.refreshSystemStatus(), 30000);
                
                console.log('Debug Console initialized successfully');
            }

            setupLogInterception() {
                // Listen for RefExtractor log events
                window.addEventListener('refextractor:log', (event) => {
                    this.addLogEntry(event.detail);
                });

                window.addEventListener('refextractor:error', (event) => {
                    this.addLogEntry({
                        level: 'ERROR',
                        message: event.detail.message,
                        timestamp: new Date().toISOString(),
                        data: event.detail
                    });
                });
            }

            addLogEntry(entry) {
                this.logEntries.push(entry);
                
                // Limit log entries
                if (this.logEntries.length > 1000) {
                    this.logEntries = this.logEntries.slice(-1000);
                }
                
                this.updateLogDisplay();
            }

            updateLogDisplay() {
                const container = document.getElementById('log-container');
                const level = this.currentLogLevel;
                
                let filteredLogs = this.logEntries;
                if (level !== 'all') {
                    filteredLogs = this.logEntries.filter(entry => 
                        entry.level.toLowerCase() === level.toLowerCase()
                    );
                }

                // Show latest 100 entries
                const recentLogs = filteredLogs.slice(-100);
                
                container.innerHTML = recentLogs.map(entry => {
                    const levelClass = `log-${entry.level.toLowerCase()}`;
                    return `
                        <div class="log-entry ${levelClass}">
                            <strong>[${entry.timestamp}] [${entry.level}]</strong> ${entry.message}
                            ${entry.data ? `<br><small class="text-muted">${JSON.stringify(entry.data, null, 2)}</small>` : ''}
                        </div>
                    `;
                }).join('');

                // Auto-scroll to bottom
                container.scrollTop = container.scrollHeight;
            }

            checkModuleStatus() {
                const container = document.getElementById('module-status-container');
                const details = document.getElementById('module-details');
                
                let loaded = 0;
                let moduleDetails = [];

                const moduleInfo = this.modules.map(moduleName => {
                    const isLoaded = window[moduleName] !== undefined;
                    if (isLoaded) loaded++;

                    const status = isLoaded ? 'loaded' : 'error';
                    const badgeClass = isLoaded ? 'module-loaded' : 'module-error';
                    
                    moduleDetails.push(`${moduleName}: ${isLoaded ? 'OK' : 'MISSING'}`);
                    
                    return `<span class="module-badge ${badgeClass}">${moduleName}</span>`;
                });

                container.innerHTML = moduleInfo.join('');
                details.innerHTML = moduleDetails.map(detail => 
                    `<div class="log-entry">${detail}</div>`
                ).join('');

                document.getElementById('modules-loaded').textContent = `${loaded}/${this.modules.length}`;
            }

            refreshSystemStatus() {
                // Update uptime
                const uptime = Math.floor((Date.now() - this.startTime) / 1000);
                const uptimeText = this.formatUptime(uptime);
                document.getElementById('system-uptime').textContent = `Uptime: ${uptimeText}`;

                // Update health status
                const health = this.calculateSystemHealth();
                document.getElementById('system-health').textContent = health.status;
                document.getElementById('system-health').className = health.class;

                // Update error count
                const errorCount = this.logEntries.filter(e => e.level === 'ERROR').length;
                document.getElementById('error-count').textContent = errorCount.toString();

                // Update performance score
                const performance = this.calculatePerformanceScore();
                document.getElementById('performance-score').textContent = `${performance}%`;
            }

            calculateSystemHealth() {
                const errors = this.logEntries.filter(e => e.level === 'ERROR').length;
                const moduleLoadedCount = this.modules.filter(m => window[m] !== undefined).length;
                const moduleRatio = moduleLoadedCount / this.modules.length;

                if (errors === 0 && moduleRatio === 1) {
                    return { status: 'Excellent', class: 'text-success' };
                } else if (errors < 5 && moduleRatio > 0.8) {
                    return { status: 'Good', class: 'text-warning' };
                } else {
                    return { status: 'Issues Detected', class: 'text-danger' };
                }
            }

            calculatePerformanceScore() {
                const errors = this.logEntries.filter(e => e.level === 'ERROR').length;
                const warnings = this.logEntries.filter(e => e.level === 'WARN').length;
                const moduleLoadedCount = this.modules.filter(m => window[m] !== undefined).length;
                
                let score = 100;
                score -= errors * 10;
                score -= warnings * 2;
                score -= (this.modules.length - moduleLoadedCount) * 15;
                
                return Math.max(0, Math.min(100, score));
            }

            updateSystemInfo() {
                const info = {
                    'Browser': navigator.userAgent.split(' ').slice(-2).join(' '),
                    'Platform': navigator.platform,
                    'Language': navigator.language,
                    'Screen Resolution': `${screen.width}x${screen.height}`,
                    'Viewport': `${window.innerWidth}x${window.innerHeight}`,
                    'Online Status': navigator.onLine ? 'Online' : 'Offline',
                    'Local Storage': localStorage ? 'Available' : 'Not Available',
                    'Session Storage': sessionStorage ? 'Available' : 'Not Available',
                    'Cookies Enabled': navigator.cookieEnabled ? 'Yes' : 'No'
                };

                const table = document.getElementById('system-info-table');
                table.innerHTML = Object.entries(info).map(([key, value]) => 
                    `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`
                ).join('');

                this.updateMemoryInfo();
            }

            updateMemoryInfo() {
                const container = document.getElementById('memory-info');
                
                if (performance.memory) {
                    const memory = performance.memory;
                    const used = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                    const total = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                    const limit = Math.round(memory.jsHeapSizeLimit / 1024 / 1024);
                    const percentage = Math.round((used / limit) * 100);

                    container.innerHTML = `
                        <div class="mb-2">
                            <strong>JS Heap:</strong> ${used} MB / ${limit} MB (${percentage}%)
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar ${percentage > 80 ? 'bg-danger' : percentage > 60 ? 'bg-warning' : 'bg-success'}" 
                                 style="width: ${percentage}%"></div>
                        </div>
                        <small class="text-muted">Total allocated: ${total} MB</small>
                    `;
                } else {
                    container.innerHTML = '<div class="text-muted">Memory information not available</div>';
                }

                this.updatePerformanceMetrics();
            }

            updatePerformanceMetrics() {
                const container = document.getElementById('performance-metrics');
                const logger = window.RefExtractorLogger;
                
                if (logger && logger.getPerformanceStats) {
                    const stats = logger.getPerformanceStats();
                    container.innerHTML = `
                        <div class="row">
                            <div class="col-6">
                                <small><strong>Active Marks:</strong> ${stats.activeMarks.length}</small>
                            </div>
                            <div class="col-6">
                                <small><strong>Log Count:</strong> ${stats.logCount}</small>
                            </div>
                        </div>
                        <div class="row mt-1">
                            <div class="col-6">
                                <small><strong>Memory Snapshots:</strong> ${stats.memorySnapshots.length}</small>
                            </div>
                            <div class="col-6">
                                <small><strong>Last Log:</strong> ${stats.lastLogTime ? new Date(stats.lastLogTime).toLocaleTimeString() : 'None'}</small>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-muted">Performance metrics not available</div>';
                }
            }

            setupEventListeners() {
                // Log level filter
                document.querySelectorAll('input[name="logLevel"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.currentLogLevel = e.target.value;
                        this.updateLogDisplay();
                    });
                });
            }

            formatUptime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m ${secs}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${secs}s`;
                } else {
                    return `${secs}s`;
                }
            }
        }

        // Global functions for button handlers
        function clearLogs() {
            if (window.debugConsole) {
                window.debugConsole.logEntries = [];
                window.debugConsole.updateLogDisplay();
            }
        }

        function refreshConsole() {
            if (window.debugConsole) {
                window.debugConsole.refreshSystemStatus();
                window.debugConsole.checkModuleStatus();
                window.debugConsole.updateSystemInfo();
            }
        }

        function runBasicTests() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<div class="text-muted">Running basic tests...</div>';
            
            setTimeout(() => {
                const tests = [
                    { name: 'Config Module', result: window.RefExtractorConfig !== undefined },
                    { name: 'Logger Module', result: window.RefExtractorLogger !== undefined },
                    { name: 'Error Handler Module', result: window.RefExtractorErrorHandler !== undefined },
                    { name: 'Document Parser Module', result: window.RefExtractorDocumentParser !== undefined },
                    { name: 'Field Extractor Module', result: window.RefExtractorFieldExtractor !== undefined }
                ];

                const results = tests.map(test => {
                    const resultClass = test.result ? 'success' : 'error';
                    const icon = test.result ? '✓' : '✗';
                    return `<div class="test-result ${resultClass}">${icon} ${test.name}</div>`;
                }).join('');

                container.innerHTML = results;
            }, 1000);
        }

        function runPerformanceTests() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<div class="text-muted">Running performance tests...</div>';
            
            // Placeholder for performance tests
            setTimeout(() => {
                container.innerHTML = `
                    <div class="test-result success">✓ Module loading time: < 100ms</div>
                    <div class="test-result success">✓ Memory usage: Normal</div>
                    <div class="test-result success">✓ Event binding: < 50ms</div>
                `;
            }, 2000);
        }

        function runIntegrationTests() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<div class="text-muted">Running integration tests...</div>';
            
            // Placeholder for integration tests
            setTimeout(() => {
                container.innerHTML = `
                    <div class="test-result success">✓ Module communication: OK</div>
                    <div class="test-result success">✓ Event system: OK</div>
                    <div class="test-result success">✓ Error handling: OK</div>
                `;
            }, 1500);
        }

        function testFileProcessing() {
            const fileInput = document.getElementById('test-file');
            const container = document.getElementById('file-test-results');
            
            if (!fileInput.files[0]) {
                container.innerHTML = '<div class="test-result error">✗ No file selected</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-muted">Testing file processing...</div>';
            
            // Placeholder for file testing
            setTimeout(() => {
                container.innerHTML = `
                    <div class="test-result success">✓ File type validation: Passed</div>
                    <div class="test-result success">✓ File size check: Passed</div>
                    <div class="test-result success">✓ ZIP structure: Valid</div>
                `;
            }, 2000);
        }

        function exportLogs() {
            if (window.RefExtractorLogger && window.RefExtractorLogger.exportLogs) {
                const logs = window.RefExtractorLogger.exportLogs();
                const blob = new Blob([logs], { type: 'application/json' });
                saveAs(blob, `refextractor-logs-${new Date().toISOString().slice(0, 10)}.json`);
            }
        }

        function exportSystemInfo() {
            const systemInfo = {
                timestamp: new Date().toISOString(),
                browser: navigator.userAgent,
                modules: window.debugConsole ? window.debugConsole.modules.map(m => ({
                    name: m,
                    loaded: window[m] !== undefined
                })) : [],
                memory: performance.memory ? {
                    used: performance.memory.usedJSHeapSize,
                    total: performance.memory.totalJSHeapSize,
                    limit: performance.memory.jsHeapSizeLimit
                } : null
            };
            
            const blob = new Blob([JSON.stringify(systemInfo, null, 2)], { type: 'application/json' });
            saveAs(blob, `refextractor-system-info-${new Date().toISOString().slice(0, 10)}.json`);
        }

        function exportErrorReport() {
            if (window.RefExtractorErrorHandler && window.RefExtractorErrorHandler.exportErrorReport) {
                const report = window.RefExtractorErrorHandler.exportErrorReport();
                const blob = new Blob([report], { type: 'application/json' });
                saveAs(blob, `refextractor-error-report-${new Date().toISOString().slice(0, 10)}.json`);
            }
        }

        function generateDiagnostics() {
            const diagnostics = {
                timestamp: new Date().toISOString(),
                system: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    onLine: navigator.onLine
                },
                modules: window.debugConsole ? window.debugConsole.modules.reduce((acc, m) => {
                    acc[m] = window[m] !== undefined;
                    return acc;
                }, {}) : {},
                logs: window.debugConsole ? window.debugConsole.logEntries.slice(-50) : [],
                performance: performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                } : null
            };
            
            const blob = new Blob([JSON.stringify(diagnostics, null, 2)], { type: 'application/json' });
            saveAs(blob, `refextractor-diagnostics-${new Date().toISOString().slice(0, 10)}.json`);
        }

        // Initialize debug console when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.debugConsole = new DebugConsole();
        });
    </script>
</body>
</html>
